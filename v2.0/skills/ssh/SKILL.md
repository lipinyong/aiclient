---
name: ssh
description: 生成或解释 SSH、SCP、SFTP 相关命令与配置。当用户要连接远程、执行远程命令、传文件、配置密钥、跳板机或排查 SSH 问题时使用。
triggers: [ssh, scp, 远程, 服务器, 连接服务器, 传文件, 密钥, 跳板, sftp, 免密, authorized_keys]
---

# SSH 技能

## 使用场景

- 用户要求「SSH 连接」「远程执行命令」「传文件到服务器」「配置免密」「跳板机」「scp/sftp」等
- 涉及：`ssh`、`scp`、`sftp`、`~/.ssh/config`、密钥、端口、代理

## 行为规范

1. **安全**：不要求用户提供密码；优先推荐密钥认证，并说明如何生成与配置。
2. **可执行性**：命令可直接复制使用，占位符用 `<用户>`、`<主机>`、`<端口>`、`<本地路径>`、`<远程路径>` 等标出。
3. **输出形式**：用代码块包裹命令，并简要说明参数含义。

## 常用命令模板

### 连接与远程执行

```bash
# 基本连接（默认 22 端口）
ssh <用户>@<主机>

# 指定端口
ssh -p <端口> <用户>@<主机>

# 执行单条命令后退出
ssh <用户>@<主机> "命令"

# 使用指定私钥
ssh -i ~/.ssh/id_rsa <用户>@<主机>
```

### 传文件（scp）

```bash
# 本机 -> 远程
scp -P <端口> <本地路径> <用户>@<主机>:<远程路径>

# 远程 -> 本机
scp -P <端口> <用户>@<主机>:<远程路径> <本地路径>

# 递归目录
scp -r <本地目录> <用户>@<主机>:<远程路径>
```

### 配置文件 ~/.ssh/config

```
Host <别名>
    HostName <主机名或IP>
    User <用户>
    Port 22
    IdentityFile ~/.ssh/id_rsa
    # 跳板机示例
    # ProxyJump jump_user@jump_host
```

配置后可直接：`ssh <别名>`。

### 密钥与权限

- 生成密钥：`ssh-keygen -t ed25519 -C "备注"`（或 `-t rsa -b 4096`）
- 公钥拷到远程：`ssh-copy-id -p <端口> <用户>@<主机>`
- 私钥权限：`chmod 600 ~/.ssh/id_rsa`；目录：`chmod 700 ~/.ssh`

## 常见问题

- **Permission denied (publickey)**：检查本机公钥是否已写入远程 `~/.ssh/authorized_keys` 及权限（600）。
- **端口不是 22**：用 `-p`（ssh）或 `-P`（scp）指定。
- **跳板机**：使用 `ProxyJump` 或 `ssh -J jump_user@jump_host 目标_user@目标_host`。

## 说明

- **当用户提供主机、账号、密码并要求执行命令或分析系统时**：必须使用 **ssh_run** 工具直接连接并执行命令，再根据工具返回的 stdout/stderr 进行分析总结、给出结论；不要只给操作建议。
- **多轮对话中换主机时**：若用户在本轮消息中提供了与之前**不同的主机 IP 或账号/密码**，表示要连接的是**新主机**，必须针对**本轮给出的 host/user/password** 重新调用 ssh_run，不得引用上一轮的主机或结果；回答开头须标明「以下为主机 [本轮IP] 的检查结果」。
- 仅当用户仅问「如何做」或未提供连接信息时，才给出命令模板与配置说明。
- 若用户提供主机/用户名等具体信息，应代入 ssh_run 执行并分析结果。
